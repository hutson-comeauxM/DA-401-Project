---
title: "longitutdal_conversion"
format: html
editor: visual
---

```{r}

library(tidyverse)
ipeds_raw <- read_csv("IPEDS_data_1105.csv")

ipeds_clean <- ipeds_raw %>%
  # Clean "NA"/"NULL" strings safely
  mutate(across(where(is.character), ~na_if(., "NA"))) %>%
  mutate(across(where(is.character), ~na_if(., "NULL")))
```


```{r}
# Identify your ID columns (modify if you have slightly different names)
id_vars <- c(
  "UnitID", "Institution Name",
  "Control of institution (HD2023)",
  "Carnegie Classification 2025: Institutional Classification (HD2024)",
  "Carnegie Classification 2025: Research Activity Designation (HD2024)",
  "Carnegie Classification 2025: Institutional Size (HD2024)",
  "State abbreviation (HD2022)"
)

# --- Helper function for pivoting each variable block ---
pivot_variable <- function(df, pattern, var_name) {
  matched_cols <- grep(pattern, names(df), value = TRUE)
  if (length(matched_cols) == 0) {
    warning(paste("No columns matched pattern for:", var_name))
    return(NULL)
  }
  df %>%
    select(all_of(id_vars), all_of(matched_cols)) %>%
    pivot_longer(
      cols = all_of(matched_cols),
      names_to = "year",
      names_pattern = ".*?(20\\d{2}).*",
      values_to = var_name
    ) %>%
    mutate(year = as.numeric(year))
}

# --- Flexible regex patterns for your dataset ---
retention_pattern     <- "Full[- ]?time retention rate.*\\(EF\\d{4}D\\)"
admit_pattern         <- "Percent admitted.*\\(DRV(ADM|IC)\\d{4}\\)"
yield_pattern         <- "Admissions yield.*\\(DRV(ADM|IC)\\d{4}\\)"
grad_total_pattern    <- "Graduation rate.*total cohort.*\\(DRVGR\\d{4}\\)"
grad_4yr_pattern      <- "Graduation rate.*Bachelor.*4 year.*total.*\\(DRVGR\\d{4}\\)"
instr_gasb_pattern    <- "Instruction expenses per FTE.*GASB.*\\(DRVF\\d{4}\\)"
instr_fasb_pattern    <- "Instruction expenses per FTE.*FASB.*\\(DRVF\\d{4}\\)"
instr_profit_pattern  <- "Instruction expenses per FTE.*for[- ]?profit.*\\(DRVF\\d{4}\\)"
headcount_pattern     <- "12[- ]?month unduplicated headcount.*\\(DRVEF12\\d{4}\\)"

# --- Pivot each variable block ---
retention    <- pivot_variable(ipeds_clean, retention_pattern, "Full-time retention rate")
admit        <- pivot_variable(ipeds_clean, admit_pattern, "Percent Admitted")
yield        <- pivot_variable(ipeds_clean, yield_pattern, "Admission yield")
grad_total   <- pivot_variable(ipeds_clean, grad_total_pattern, "Graduation rate total cohort")
grad_4yr     <- pivot_variable(ipeds_clean, grad_4yr_pattern, "Graduation rate - within 4 years total")
instr_gasb   <- pivot_variable(ipeds_clean, instr_gasb_pattern, "Instruction expenses per FTE (GASB)")
instr_fasb   <- pivot_variable(ipeds_clean, instr_fasb_pattern, "Instruction expenses per FTE (FASB)")
instr_profit <- pivot_variable(ipeds_clean, instr_profit_pattern, "Instruction expenses per FTE (for-profit institutions)")
headcount    <- pivot_variable(ipeds_clean, headcount_pattern, "Total 12-month unduplicated headcount")

# --- Combine all long datasets ---
panel_ipeds <- list(
  retention, admit, yield, grad_total, grad_4yr,
  instr_gasb, instr_fasb, instr_profit, headcount
) %>%
  compact() %>%
  reduce(full_join, by = c(id_vars, "year")) %>%
  arrange(UnitID, year)

# --- Fix “year = 1220” issue & clean NAs ---
panel_ipeds <- panel_ipeds %>%
  mutate(year = ifelse(year == 1220, 2020, year)) %>%
  mutate(across(where(is.character), ~na_if(., "NA"))) %>%
  mutate(across(where(is.character), ~na_if(., "NULL"))) %>%
  mutate(across(matches("rate|Admitted|yield|expenses|headcount"), ~as.numeric(.)))

# --- NEW: Keep one row per institution-year (max headcount) ---
panel_ipeds <- panel_ipeds %>%
  group_by(UnitID, year) %>%
  slice_max(`Total 12-month unduplicated headcount`, with_ties = FALSE) %>%
  ungroup()
```

```{r}
# Shift Percent Admitted and Admission Yield down by one year and remove 2013 rows
ipeds_panel_adj <- panel_ipeds %>%
  group_by(UnitID) %>% 
  arrange(UnitID, year) %>%
  # Shift the variables down by one year within each university
  mutate(
    `Percent Admitted` = dplyr::lead(`Percent Admitted`, n = 1),
    `Admission yield` = dplyr::lead(`Admission yield`, n = 1)
  ) %>%
  ungroup() %>%
  # Remove the 2013 row, since those now represent pre-shifted values
  filter(year > 2013) %>%
  # Add Post-COVID dummy variable
  mutate(`Post-covid` = if_else(year > 2020, 1, 0))

# Optional: reorder columns for convenience
ipeds_panel_adj <- ipeds_panel_adj %>%
  select(
    UnitID, `Institution Name`, year, `Post-covid`,
    everything()
  )

```

```{r}
ipeds_panel_adj2 <- ipeds_panel_adj %>%
  mutate(
    `Instruction expenses per FTE` = coalesce(
      `Instruction expenses per FTE (GASB)`,
      `Instruction expenses per FTE (FASB)`,
      `Instruction expenses per FTE (for-profit institutions)`
    )
  ) %>%
  select(
    -`Instruction expenses per FTE (GASB)`,
    -`Instruction expenses per FTE (FASB)`,
    -`Instruction expenses per FTE (for-profit institutions)`
  )
```

```{r}
#Load in the US New LA 
usnews <- read_csv("US-News-Rankings-Liberal-Arts-Colleges-Through-2026 (1).csv")

ipeds_panel_new <- ipeds_panel_adj2 %>%
  mutate(
    `School Type` = case_when(
      # Small Liberal Arts
      UnitID %in% usnews$`IPEDS ID` &
        `Carnegie Classification 2025: Institutional Size (HD2024)` %in% c(1, 2) ~ "SLA",
      
      # Large Research Institutions
      `Carnegie Classification 2025: Institutional Size (HD2024)` %in% c(4,5) &
        `Carnegie Classification 2025: Research Activity Designation (HD2024)` %in% c(1, 2) ~ "LRI",
      
      # Everything else should be NA
      TRUE ~ NA_character_
    )
  )

ipeds_panel_did <- ipeds_panel_new %>%
  filter(`School Type` %in% c("SLA", "LRI"))
```


```{r}
readr::write_csv(ipeds_panel_did, "ipeds_panel.csv")
```

